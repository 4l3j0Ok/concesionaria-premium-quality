---
import CarCard from "./CarCard.astro";
import { getCar } from "../lib/cars";
import { mapCarFromAPI, type Car } from "../types/car";
import { Icon } from "astro-icon/components";

// Inicializar con array vacío
let cars: Car[] = [];

try {
  const carsResponse = await getCar();
  console.log("API Response:", carsResponse);

  if (carsResponse && Array.isArray(carsResponse.items)) {
    // Mapear los datos de la API al formato esperado por el componente
    cars = carsResponse.items.map(mapCarFromAPI);
    cars = cars.filter(
      (car) => car.promotionPrice && car.promotionPrice < car.price,
    );
  }
} catch (error) {
  console.error("Error fetching cars from API:", error);
  cars = [];
}

console.log("Final cars array:", cars);
---

<section class="offers" id="offers">
  <h2>Ofertas</h2>
  <div class="offers-content">
    <button class="arrow-button" id="prev-button"
      ><Icon name="bxs:left-arrow" /></button
    >
    <div class="offers-cars">
      {
        cars.length > 0 ? (
          cars.map((car: Car) => <CarCard car={car} />)
        ) : (
          <div class="no-cars-message">
            <p>No hay vehículos disponibles en este momento.</p>
            <p>
              Por favor, verifica que la API esté funcionando correctamente.
            </p>
          </div>
        )
      }
    </div>
    <button class="arrow-button" id="next-button">
      <Icon name="bxs:right-arrow" />
    </button>
  </div>
  <div class="view-all">
    <a href="/offers" class="view-all-offers" id="view-all-offers"
      >Ver todas las ofertas</a
    >
    <a href="/catalog" class="view-all-button" id="view-all-button"
      >Ver todo el catálogo</a
    >
  </div>
</section>

<style>
  .offers {
    margin: 2em 0;
    width: 100%;
  }

  .offers h2 {
    margin-bottom: 1em;
    text-align: center;
  }

  .offers-content {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .arrow-button {
    color: white;
    border: none;
    padding: 1em;
    border-radius: 50%;
    cursor: pointer;
    position: absolute;
    z-index: 10;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
  }

  #prev-button {
    left: 0;
  }

  #next-button {
    right: 0;
  }

  .offers-cars {
    display: flex;
    gap: 2em;
    padding: 1em;
    overflow-x: auto;
    scroll-behavior: smooth;
    scrollbar-width: none;
    max-width: calc(100vw - 120px);
    mask: linear-gradient(
      to right,
      transparent,
      black 5%,
      black 95%,
      transparent
    );
  }

  .offers-cars::-webkit-scrollbar {
    display: none;
  }

  .no-cars-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2em;
    text-align: center;
    color: #666;
    min-height: 200px;
  }

  .no-cars-message p {
    margin: 0.5em 0;
  }

  .offers .view-all {
    margin-top: 1em;
    display: flex;
    justify-content: center;
    gap: 2em;
  }

  @media (max-width: 768px) {
    .offers-cars {
      max-width: calc(100vw - 80px);
    }

    .arrow-button {
      width: 40px;
      height: 40px;
      font-size: 1em;
    }

    .offers .view-all {
      flex-direction: column;
      align-items: center;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const offersCars = document.querySelector(".offers-cars");
    const prevButton = document.getElementById("prev-button");
    const nextButton = document.getElementById("next-button");

    if (offersCars && prevButton && nextButton) {
      prevButton.addEventListener("click", () => {
        offersCars.scrollBy({ left: -300, behavior: "smooth" });
      });

      nextButton.addEventListener("click", () => {
        offersCars.scrollBy({ left: 300, behavior: "smooth" });
      });
    }
  });
</script>
