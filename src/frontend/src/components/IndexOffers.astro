---
import CarCard from "./CarCard.astro";
import { getCar } from "../lib/cars";
import { type Car } from "../types/car";
import { Icon } from "astro-icon/components";

let cars: Car[] = [];

try {
  const result = await getCar();
  console.log("Fetched cars from API:", result);

  if (Array.isArray(result)) {
    cars = result;
  } else if (result) {
    cars = [result];
  }
} catch (error) {
  console.error("Error fetching cars from API:", error);
  cars = [];
}

// Filtrar solo las ofertas (cars con promotion_price menor al precio)
const offerCars = cars.filter(
  (car) => car.promotion_price && car.promotion_price < car.price,
);

console.log("Filtered offer cars:", offerCars);
---

<section class="offers" id="offers">
  <h2>Ofertas</h2>
  <div class="offers-content">
    <button class="arrow-button" id="prev-button"
      ><Icon name="bxs:left-arrow" /></button
    >
    <div class="offers-cars">
      {
        offerCars.length > 0 ? (
          offerCars.map((car: Car) => <CarCard car={car} />)
        ) : (
          <div class="no-cars-message">
            <p>No hay ofertas disponibles en este momento.</p>
            <p>Revisa el catálogo completo para ver todos los vehículos.</p>
          </div>
        )
      }
    </div>
    <button class="arrow-button" id="next-button">
      <Icon name="bxs:right-arrow" />
    </button>
  </div>
  <div class="view-all">
    <a
      href="/offers"
      class="view-all-offers primary-button"
      id="view-all-offers">Ver todas las ofertas</a
    >
    <a
      href="/catalog"
      class="view-all-button primary-button"
      id="view-all-button">Ver todo el catálogo</a
    >
  </div>
</section>

<style>
  .offers {
    margin: 2em 0;
    width: 100%;
  }

  .offers h2 {
    margin-bottom: 1em;
    text-align: center;
  }

  .offers-content {
    position: relative;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .arrow-button {
    color: white;
    border: none;
    padding: 1em;
    border-radius: 50%;
    cursor: pointer;
    position: absolute;
    z-index: 10;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 50px;
    height: 50px;
  }

  #prev-button {
    left: 0;
  }

  #next-button {
    right: 0;
  }

  .offers-cars {
    display: flex;
    gap: 2em;
    padding: 1em;
    overflow-x: auto;
    scroll-behavior: smooth;
    scrollbar-width: none;
    max-width: calc(100vw - 120px);
    mask: linear-gradient(
      to right,
      transparent,
      black 5%,
      black 95%,
      transparent
    );
  }

  .offers-cars::-webkit-scrollbar {
    display: none;
  }

  .no-cars-message {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 2em;
    text-align: center;
    color: #666;
    min-height: 200px;
  }

  .no-cars-message p {
    margin: 0.5em 0;
  }

  .offers .view-all {
    margin-top: 1em;
    display: flex;
    justify-content: center;
    gap: 2em;
  }

  @media (max-width: 600px) {
    .offers .view-all {
      flex-direction: column;
      align-items: center;
      gap: 1em;
    }
  }

  @media (max-width: 768px) {
    .offers-cars {
      max-width: calc(100vw - 80px);
    }

    .arrow-button {
      width: 40px;
      height: 40px;
      font-size: 1em;
    }
  }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const offersCars = document.querySelector(".offers-cars");
    const prevButton = document.getElementById("prev-button");
    const nextButton = document.getElementById("next-button");

    if (offersCars && prevButton && nextButton) {
      prevButton.addEventListener("click", () => {
        offersCars.scrollBy({ left: -300, behavior: "smooth" });
      });

      nextButton.addEventListener("click", () => {
        offersCars.scrollBy({ left: 300, behavior: "smooth" });
      });
    }
  });
</script>
